<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket ËÅäÂ§©ÂÆ¢Êà∑Á´Ø</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/config.js"></script>
    <style>
        /* Áé∞ÊúâÁöÑ CSS Ê†∑Âºè */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #d0e7ff;
            text-align: center;
            overflow: hidden;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100vw;
            overflow: hidden;
        }
        .chat-header {
            display: flex;
            align-items: center;
            background-color: white;
            color: #4a90e2;
            border-bottom: 2px solid #b0c7e1;
            padding: 20px 10px;
        }
        .chat-header button {
            background-color: transparent;
            border: none;
            font-size: 1.25rem;
            color: #4a90e2;
            cursor: pointer;
            margin-right: 10px;
        }
        .chat-header h2 {
            margin: 0;
            flex: 1;
            text-align: center;
        }
        .chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            overflow-y: auto;
            background-color: #e9f4ff;
            padding-top: 10px;
        }
        .message {
            max-width: 70%;
            padding: 0.4rem 1rem;
            border-radius: 1.25rem;
            display: inline-block;
            word-wrap: break-word;
            position: relative;
            margin-bottom: 0.3125rem;
        }
        .message-left {
            background-color: #ffffff;
            border: 1px solid #b0c7e1;
            align-self: flex-start;
            margin-left: 10px;
        }
        .message-right {
            background-color: #4a90e2;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            margin-right: 10px;
        }
        .chat-footer {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background-color: white;
            border-top: 2px solid #b0c7e1;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        .chat-footer input[type="text"] {
            flex: 1;
            padding: 0.625rem;
            border-radius: 1.25rem;
            border: 1px solid #b0c7e1;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .chat-footer button {
            padding: 0.625rem 1.25rem;
            border-radius: 1.25rem;
            border: none;
            background-color: #4a90e2;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }
        .chat-footer input[type="file"] {
            display: none;
        }
        .upload-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <span class="back-button" id="back-button">‚Üê</span>
        <h2 id="welcomeMessage">Ê≠£Âú®Âª∫Á´ãËøûÊé•...</h2>
    </div>
    <div id="messages" class="chat-body">
        <span id="successMessage"></span>
    </div>
    <div class="chat-footer">
        <input id="messageInput" type="text" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
        <button class="upload-button" id="uploadButton">üìé</button>
        <button id="sendButton">ÂèëÈÄÅ</button>
        <input id="fileInput" type="file" accept="image/*,video/*">
    </div>
</div>

<script>
    let socket;
    let pageNum = 1;
    const pageSize = 20;
    let search = true;
    let noMoreMessagesDisplayed = false;

    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    console.log(userId);
    console.log(userName);

    loadHistoryMessages(pageNum);
    initializeWebSocket();

    async function loadHistoryMessages(pageNum) {
        try {
            if (!search) {
                if (!noMoreMessagesDisplayed) {
                    displayNoMoreMessages();
                    noMoreMessagesDisplayed = true;
                }
                return;
            }
            const response = await fetch(`${API_BASE_URL}/chatMessage/searchMessage?acceptUserId=${userId}&pageNum=${pageNum}&pageSize=${pageSize}`);
            if (!response.ok) {
                throw new Error('ÁΩëÁªúÂìçÂ∫îÂ§±Ë¥•: ' + response.statusText);
            }
            const historyMessages = await response.json();
            if (historyMessages.code === 200) {
                if (historyMessages.data.current >= historyMessages.data.pages) {
                    search = false;
                }
                displayHistoryMessages(historyMessages.data.records);
            }
        } catch (error) {
            console.error('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÊó∂Âá∫Èîô:', error);
        }
    }

    function displayHistoryMessages(messages) {
        const messagesDiv = document.getElementById('messages');
        messages.forEach(msg => {
            const sender = String(msg.sendUserId) === String(userId) ? 'ÂØπÊñπ' : 'Ëá™Â∑±';
            addMessage(sender, msg.content, msg.createTime, msg.isReader);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function initializeWebSocket() {
        socket = new WebSocket(WEBSOCKET_BASE_URL + '/chat?' + userId);
        socket.addEventListener('open', event => {
            console.log('ËøûÊé•Â∑≤Âª∫Á´ã');
            document.getElementById('welcomeMessage').innerText = userName;
        });

        socket.addEventListener('message', event => {
            addMessage('ÂØπÊñπ', event.data);
            window.parent.postMessage({
                type: 'websocketMessage',
                data: event.data
            }, '*');
        });

        socket.addEventListener('close', event => {
            console.log('ËøûÊé•Â∑≤ÂÖ≥Èó≠');
        });

        socket.addEventListener('error', event => {
            console.error('WebSocket ÈîôËØØ:', event);
        });
    }

    function addMessage(sender, message, timestamp = '', isReader) {
        const messagesDiv = document.getElementById('messages');

        const messageWrapper = document.createElement('div');
        messageWrapper.style.display = 'flex';
        messageWrapper.style.flexDirection = 'column';
        messageWrapper.style.alignItems = sender === 'ÂØπÊñπ' ? 'flex-start' : 'flex-end';
        messageWrapper.style.marginBottom = '10px';

        const timeElement = document.createElement('div');
        timeElement.style.fontSize = '0.75rem';
        timeElement.style.color = '#888';
        timeElement.textContent = timestamp;

        const newMessage = document.createElement('div');
        if (!isReader && sender === 'ÂØπÊñπ') {
            newMessage.style.color = '#F44336';
        }
        newMessage.classList.add('message', sender === 'ÂØπÊñπ' ? 'message-left' : 'message-right');
        // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÂåÖÂê´ base64 ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ
        // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶ÂåÖÂê´ base64 ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ
        if (message.startsWith('data:image')) {
            const imgElement = document.createElement('img');
            imgElement.src = message;
            imgElement.style.maxWidth = '100%';
            imgElement.style.maxHeight = '300px';
            imgElement.style.cursor = 'pointer'; // Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÂÖâÊ†á

            // ÁÇπÂáª‰∫ã‰ª∂ÔºåÂºπÂá∫Ê®°ÊÄÅÊ°ÜÊòæÁ§∫ÂÆåÊï¥ÂõæÁâá
            imgElement.addEventListener('click', () => {
                showImageInModal(message);
            });

            newMessage.appendChild(imgElement);
        }else {
            newMessage.innerHTML = message;
        }

        messageWrapper.appendChild(newMessage);
        messageWrapper.appendChild(timeElement);

        messagesDiv.appendChild(messageWrapper);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displayNoMoreMessages() {
        const messagesDiv = document.getElementById('messages');
        const noMoreMessages = document.createElement('div');
        noMoreMessages.style.textAlign = 'center';
        noMoreMessages.style.color = '#888';
        noMoreMessages.style.padding = '10px 0';
        noMoreMessages.textContent = 'Â∑≤Êó†Êõ¥Êó©ÁöÑÊ∂àÊÅØ';
        messagesDiv.prepend(noMoreMessages);
    }

    document.getElementById('sendButton').addEventListener('click', () => {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        if (message) {
            addMessage('Ëá™Â∑±', message);
            socket.send(message);
            messageInput.value = '';
        }
    });

    document.getElementById('messageInput').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            document.getElementById('sendButton').click();
        }
    });

    document.getElementById('messages').addEventListener('scroll', () => {
        const messagesDiv = document.getElementById('messages');
        if (messagesDiv.scrollTop === 0) {
            pageNum++;
            loadHistoryMessages(pageNum);
        }
    });

    document.getElementById("back-button").addEventListener("click", function () {
        window.top.location.href = 'userList.html';
    });

    document.getElementById('uploadButton').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileType = file.type.split('/')[0]; // image or video
                const fileUrl = e.target.result;
                const message = `<${fileType} src="${fileUrl}" style="max-width: 100%; max-height: 300px; cursor: pointer;">`;
                addMessage('Ëá™Â∑±', message);

                // ‰∏∫ÂõæÁâáÊ∑ªÂä†ÁÇπÂáªÊîæÂ§ß‰∫ã‰ª∂
                if (fileType === 'image') {
                    const imgElement = document.querySelector(`img[src="${fileUrl}"]`);
                    if (imgElement) {
                        imgElement.addEventListener('click', () => {
                            showImageInModal(fileUrl);
                        });
                    }
                }

                // ‰ΩøÁî®FormDataÂèëÈÄÅÊñá‰ª∂
                const formData = new FormData();
                formData.append("file", file);

                fetch(API_BASE_URL + '/chatMessage/file/' + userId, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Êñá‰ª∂‰∏ä‰º†ÊàêÂäü', data);
                    })
                    .catch(error => {
                        console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•', error);
                    });
            };
            reader.readAsDataURL(file);
        }
    });

    function showImageInModal(imageSrc) {
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        const fullImg = document.createElement('img');
        fullImg.src = imageSrc;
        fullImg.style.width = 'auto';
        fullImg.style.height = 'auto';
        fullImg.style.maxWidth = '90%';
        fullImg.style.maxHeight = '90%';

        modal.appendChild(fullImg);

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÂõæÁâáÊü•Áúã
        modal.addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        document.body.appendChild(modal);
    }

</script>
</body>
</html>